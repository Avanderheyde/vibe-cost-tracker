name: Sync selfstack registry

on:
  push:
    branches: [main]
    paths:
      - selfstack.yml

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read version from selfstack.yml
        id: version
        run: |
          VERSION=$(grep '^version:' selfstack.yml | awk '{print $2}')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update registry
        uses: actions/github-script@v7
        env:
          APP_VERSION: ${{ steps.version.outputs.version }}
        with:
          github-token: ${{ secrets.REGISTRY_PAT }}
          script: |
            const version = process.env.APP_VERSION;
            const owner = 'Avanderheyde';
            const repo = 'selfstack-registry';
            const path = 'registry.json';

            // Fetch current registry.json
            const { data: file } = await github.rest.repos.getContent({ owner, repo, path });
            const content = Buffer.from(file.content, 'base64').toString();
            const registry = JSON.parse(content);

            // Update vibe-costs version
            const app = registry.apps.find(a => a.name === 'vibe-costs');
            if (!app) {
              core.setFailed('vibe-costs not found in registry');
              return;
            }
            if (app.version === version) {
              core.info(`Already at ${version}, skipping`);
              return;
            }
            app.version = version;

            // Commit directly to main
            const updated = JSON.stringify(registry, null, 2) + '\n';
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `chore: bump vibe-costs to ${version}`,
              content: Buffer.from(updated).toString('base64'),
              sha: file.sha,
            });
            core.info(`Updated registry to ${version}`);
